# Intelligent AR Collections & Dunning System — Setup Guide

An AI-powered accounts receivable collections and dunning solution built with Azure OpenAI,
Microsoft Dynamics 365, Microsoft Graph, and Copilot Studio.

---

## Features

- **AI Risk Scoring**: Three-factor weighted algorithm (Aging 50%, Payment History 30%, Promise Keeping 20%)
- **Automated Prioritization**: Rank customers by combined risk score and outstanding balance
- **GPT-5 Powered Communications**: Personalized dunning emails and Teams messages generated by Azure OpenAI
- **Payment Plan Proposals**: Automatically create and email tailored payment schedules
- **Promise Tracking**: Track customer payment commitments and fulfillment rates from Dynamics 365
- **Multi-Channel Outreach**: Email via Outlook and Teams messaging for internal follow-up
- **Copilot Studio Agent**: Natural language interface for collections queries in M365 Copilot Chat
- **Real-Time Dynamics 365 Integration**: Live data from Account, Invoice, Task, and Appointment entities

---

## Project Structure

```
src/
├── agents/
│   ├── collectionsAgent.ts       # Main orchestration — coordinates all services
│   └── declarativeAgent.json     # Copilot Studio agent definition
├── connectors/
│   ├── erpConnector.ts           # Dynamics 365 OData REST API integration
│   └── graphConnector.ts         # Microsoft Graph (email + Teams)
├── services/
│   ├── riskScoringService.ts     # Weighted risk algorithm + Azure OpenAI
│   ├── dunningService.ts         # GPT-5 communication generation
│   └── paymentPlanService.ts     # Payment schedule calculation
├── utils/
│   ├── testAzureOpenAI.ts        # Test Azure OpenAI connectivity
│   ├── createSampleInvoices.ts   # Create test data in Dynamics 365
│   └── discoverEntities.ts       # Discover available D365 entities
├── types.ts                      # TypeScript interfaces
└── index.ts                      # Main entry point
examples/
└── collections-workflow.ts       # Runnable workflow examples
docs/
├── SETUP.md                      # This file
├── ARCHITECTURE.md               # System architecture overview
└── COPILOT_STUDIO_PLUGINS.md     # Copilot Studio agent configuration
```

---

## Prerequisites

- **Node.js 18+**
- **Azure OpenAI** resource with GPT-4 or GPT-5 deployment
- **Dynamics 365** environment with Invoice module
- **Microsoft 365** account (for email and Teams messaging)
- **Azure AD** app registration (for Dynamics 365 access)

---

## Installation

```bash
npm install
npm run build
```

---

## Configuration

### Step 1: Copy Environment File

```bash
cp .env.example .env
```

### Step 2: Complete `.env` Configuration

```env
# Azure OpenAI
AZURE_OPENAI_ENDPOINT=https://your-resource.openai.azure.com/
AZURE_OPENAI_API_KEY=your-api-key
AZURE_OPENAI_DEPLOYMENT_NAME=gpt-5
AZURE_OPENAI_API_VERSION=2025-01-01-preview

# Microsoft Graph (Interactive Browser Authentication)
GRAPH_CLIENT_ID=your-app-registration-client-id
GRAPH_TENANT_ID=your-tenant-id

# Dynamics 365 ERP (OAuth2 Client Credentials)
ERP_API_ENDPOINT=https://your-org.api.crm.dynamics.com/api/data/v9.2
ERP_CLIENT_ID=your-app-registration-client-id
ERP_CLIENT_SECRET=your-client-secret
ERP_TENANT_ID=your-tenant-id
ERP_RESOURCE=https://your-org.api.crm.dynamics.com/

# Application Settings
PORT=3000
RISK_THRESHOLD_HIGH=0.5
RISK_THRESHOLD_MEDIUM=0.3

# Email & Teams Testing
TEST_CUSTOMER_EMAIL=your-email@domain.com       # Receives test dunning emails
TEST_COLLECTIONS_EMAIL=colleague@domain.com      # Receives Teams notifications (must be a different user)

# Data Mode
DEMO_MODE=false    # false = real Dynamics 365 data | true = mock data
```

---

## Detailed Setup: Azure OpenAI

1. Go to [Azure Portal](https://portal.azure.com) → **Azure OpenAI**
2. Create or select an existing Azure OpenAI resource
3. Navigate to **Keys and Endpoint** → copy endpoint and key
4. Go to **Model deployments** → deploy **GPT-4** or **GPT-5**
5. Note the **deployment name** for `AZURE_OPENAI_DEPLOYMENT_NAME`

**GPT-5 note**: The GPT-5 reasoning model uses tokens for internal reasoning before
generating output. The system is configured with `max_completion_tokens: 2000` to
accommodate this. No changes needed.

**Test your connection:**
```bash
npm run test-openai
```

Expected output:
```
✅ Azure OpenAI connection successful!
Model: gpt-5
Reasoning tokens: 245 | Output tokens: 8
```

---

## Detailed Setup: Dynamics 365 (ERP Connector)

The backend uses **OAuth2 client credentials flow** to authenticate with Dynamics 365.
This is a service-to-service connection that does not require user interaction.

### Step 1: Register Azure AD Application

1. Go to [Azure Portal](https://portal.azure.com)
2. Navigate to **Azure Active Directory** → **App registrations** → **New registration**
3. Name: `AR Collections Service` (or reuse an existing app)
4. Account type: **Accounts in this organizational directory only**
5. Click **Register**
6. Copy the **Application (client) ID** and **Directory (tenant) ID**

### Step 2: Create Client Secret

1. Go to **Certificates & secrets** → **Client secrets** → **New client secret**
2. Description: `AR Collections Secret`
3. Expiry: 12 or 24 months
4. Click **Add** — copy the **Value** immediately (shown only once)

### Step 3: Grant Dynamics 365 Permission

1. Go to **API permissions** → **Add a permission**
2. Select **Dynamics CRM**
3. Select **Delegated permissions**
4. Check **user_impersonation**
5. Click **Add permissions**
6. Click **Grant admin consent for [Your Organization]**

### Step 4: Create Application User in Dynamics 365

1. Log in to your Dynamics 365 environment as an administrator
2. Go to **Settings** → **Security** → **Users**
3. Switch view to **Application Users**
4. Click **New** → select **Application User** form
5. Enter:
   - **Application ID**: paste your Azure AD Client ID
   - **Full Name**: `AR Collections Service`
6. Click **Save**
7. Assign security role: **System Administrator** (or a custom role with
   read/write on Account, Invoice, Task, and Appointment entities)

### Step 5: Find Your API Endpoint

1. In Dynamics 365 → **Settings** → **Customizations** → **Developer Resources**
2. Copy the **Web API** URL
3. Format: `https://orgXXXXXXXX.api.crm.dynamics.com/api/data/v9.2`

### Step 6: Create Sample Data

After configuring Dynamics 365, create test invoices and payment history:

```bash
npm run create-invoices
```

This creates the following records per customer in Dynamics 365:
- **Invoices** across all aging buckets (Current, 30, 60, 90, 120+ days)
- **Tasks** — 20 payment history records (mix of on-time and late payments)
- **Appointments** — 8-9 promise-to-pay records (mix of fulfilled and broken)

---

## Detailed Setup: Microsoft Graph (Email + Teams)

The system uses **interactive browser authentication** — you sign in once with your
Microsoft 365 work account, and emails/Teams messages are sent from your mailbox.

### Why Interactive Browser?

- Works with **managed/corporate devices**
- Satisfies **Conditional Access** device compliance policies
- Supports **Intune-enrolled devices**
- No over-privileged application permissions

### Step 1: App Registration Platform Configuration

> **Note**: You can use the same app registration as Dynamics 365, or create a separate one.

1. Go to [Azure Portal](https://portal.azure.com) → App registrations → your app
2. Go to **Authentication**
3. Click **Add a platform** → Select **Mobile and desktop applications**
4. Check: `http://localhost` OR add custom URI: `http://localhost:3000`
5. Click **Configure**
6. Under **Advanced settings** → **Allow public client flows** → set to **Yes**
7. Click **Save**

> ⚠️ **Important**: Use **"Mobile and desktop applications"** platform — NOT "Web".
> The Web platform requires a client secret and will fail with device code/interactive flows.

### Step 2: Add API Permissions

1. Go to **API permissions** → **Add a permission**
2. Select **Microsoft Graph** → **Delegated permissions**
3. Add all of the following:

| Permission | Purpose |
|---|---|
| `Mail.Send` | Send dunning emails from your mailbox |
| `Chat.Create` | Create one-on-one Teams chats |
| `ChatMessage.Send` | Send messages in Teams chats |
| `User.Read` | Read your signed-in profile |
| `User.ReadBasic.All` | Look up recipient user profiles |

4. Click **Add permissions**
5. No admin consent needed — you will consent on first sign-in

### Step 3: Configure `.env`

```env
GRAPH_CLIENT_ID=your-app-registration-client-id
GRAPH_TENANT_ID=your-tenant-id
TEST_CUSTOMER_EMAIL=your-email@domain.com
TEST_COLLECTIONS_EMAIL=colleague@domain.com
```

> **Note**: `TEST_COLLECTIONS_EMAIL` must be a **different user** from your signed-in account.
> Teams cannot create a one-on-one chat with yourself. Use a colleague's `@yourorg.com` email.

### Step 4: First-Time Sign-In

Run any workflow command:
```bash
npx ts-node examples/collections-workflow.ts workflow
```

A browser will **automatically open**. Sign in with your **work account** (not personal
Microsoft account). Consent to the listed permissions. The browser redirects to
`http://localhost:3000` — authentication complete. Credentials are cached for future runs.

### Teams External Users

Teams messages can only be sent to users within your organization or guest users invited
to your Azure AD tenant. External email addresses (Gmail, other domains without federation)
will not work.

---

## Running the Application

### Available Commands

```bash
# Build TypeScript
npm run build

# Test Azure OpenAI connection
npm run test-openai

# Create sample Dynamics 365 data
npm run create-invoices

# Run complete workflow (risk analysis + email + Teams + CRM update)
npx ts-node examples/collections-workflow.ts workflow

# Run batch prioritization across all customers
npx ts-node examples/collections-workflow.ts batch

# Run detailed risk analysis with promise history
npx ts-node examples/collections-workflow.ts analysis

# Test Teams messaging specifically
npx ts-node examples/collections-workflow.ts teams

# Discover available Dynamics 365 entities
npx ts-node src/utils/discoverEntities.ts
```

### Workflow Behaviors

| Command | Random Customer? | Sends Email? | Sends Teams? | Updates D365? |
|---|---|---|---|---|
| `workflow` | ✅ | ✅ If TEST_CUSTOMER_EMAIL set | ✅ If high-risk | ✅ |
| `batch` | All customers | ❌ | ❌ | ❌ |
| `analysis` | First customer | ❌ | ❌ | ❌ |
| `teams` | First customer | ❌ | ✅ If TEST_COLLECTIONS_EMAIL set | ❌ |

### Demo Mode vs Production Mode

```env
DEMO_MODE=true   # Uses mock data — no Dynamics 365 connection required
DEMO_MODE=false  # Queries real Dynamics 365 data (default)
```

---

## Risk Scoring Algorithm

Three weighted factors produce a score between 0-100%:

### Factor 1: Aged Receivables (50% weight)

```
agedPercent = (days90 + days120Plus) / totalOutstanding
agingScore  = min(agedPercent * 2, 1.0)
```

High weighting reflects that 90+ day balances have the lowest collection probability.

### Factor 2: Payment History (30% weight)

```
latenessScore  = min(averagePaymentDays / 90, 1.0)
paymentScore   = (latenessScore + (1 - onTimePaymentRate)) / 2
```

Derived from **Task** records in Dynamics 365 (subject contains on-time or days-late info).

### Factor 3: Promise Keeping (20% weight)

```
promiseKeepingScore = brokenPromises / totalPromises
```

Derived from **Appointment** records in Dynamics 365 (subject contains fulfilled/broken status).

### Combined Score & Risk Levels

```
rawScore = (agingScore × 0.50) + (paymentScore × 0.30) + (promiseKeepingScore × 0.20)
```

| Risk Level | Threshold | Action |
|---|---|---|
| **High** | Score ≥ 50% | Urgent dunning email + Teams alert to collections team |
| **Medium** | Score ≥ 30% | Payment plan proposal email |
| **Low** | Score < 30% | Standard reminder email |

Thresholds are configurable via `.env`:
```env
RISK_THRESHOLD_HIGH=0.5
RISK_THRESHOLD_MEDIUM=0.3
```

---

## Copilot Studio Agent

The AR Collections Assistant is a separate conversational layer deployed in Copilot Studio.
It reads directly from Dynamics 365 and uses the risk scoring instructions to answer
natural language questions in M365 Copilot Chat.

**Knowledge sources (4 Dynamics 365 entities):**
- **Account** — customer names and notes
- **Invoice** — AR aging data and totals
- **Task** — payment history records
- **Appointment** — promise-to-pay records

See [COPILOT_STUDIO_PLUGINS.md](COPILOT_STUDIO_PLUGINS.md) for full setup instructions.

---

## Troubleshooting

### Azure OpenAI: Empty Response

**Symptom**: `npm run test-openai` returns empty or no content.
**Cause**: `max_completion_tokens` too low for GPT-5 reasoning model.
**Fix**: Already configured at 2000 tokens in `src/utils/testAzureOpenAI.ts`.

---

### Dynamics 365: Invoice Totals Show $0

**Symptom**: All invoices show $0 outstanding balance.
**Cause**: Dynamics 365 calculates `totalamount` from line items (`invoicedetails`),
not from a directly settable field.
**Fix**: Already handled — the connector queries `invoicedetails` and calculates
totals from line items automatically.

---

### Graph API: "AADSTS7000218" — Client Secret Required

**Symptom**: `Error: invalid_client: The request body must contain 'client_assertion' or 'client_secret'`
**Cause**: App registered as "Web" platform (confidential client) instead of public client.
**Fix**: In Azure Portal → Authentication → remove "Web" platform → add
"Mobile and desktop applications" platform with `http://localhost:3000`.

---

### Graph API: "Approval Required" / Admin Consent Screen

**Symptom**: Browser shows "This app requires your admin's approval".
**Cause**: Organization has a Conditional Access policy requiring admin approval for app consent.
**Fix**: Ask your admin to grant consent in Azure Portal → API permissions →
"Grant admin consent for [Organization]", OR request approval via the browser prompt.

---

### Graph API: "Duplicate chat members"

**Symptom**: `Error: Creation of 'OneOnOne' chat requires 2 members. Duplicate chat members.`
**Cause**: `TEST_COLLECTIONS_EMAIL` is the same as your signed-in account.
**Fix**: Set `TEST_COLLECTIONS_EMAIL` to a **different** user's email address.

---

### Graph API: "Resource does not exist" (Teams)

**Symptom**: `Error: Resource 'user@gmail.com' does not exist`
**Cause**: Teams can only message users within your organization or invited guest users.
**Fix**: Use a colleague's `@yourorg.com` email for `TEST_COLLECTIONS_EMAIL`.

---

### Dynamics 365: "Failed to authenticate"

**Symptom**: `Error: Failed to authenticate with Dynamics 365`
**Cause**: Missing Application User in Dynamics 365, or incorrect credentials.
**Fix**: Verify the Application User is created in D365 with the correct Azure AD
Client ID and has appropriate security roles assigned.

---

## Compliance & Security

- All communications are professional and **FDCPA compliant**
- **Delegated permissions** for Microsoft Graph — app can only act as the signed-in user
- **Interactive browser authentication** — works with Conditional Access and Intune-enrolled devices
- All collections actions are logged to Dynamics 365 account description field for **audit trails**
- Client secrets for Dynamics 365 should be stored in **Azure Key Vault** in production
- Rotate Dynamics 365 client secrets every **90 days**

---

## Related Documentation

- [ARCHITECTURE.md](ARCHITECTURE.md) — Full system architecture and data flow
- [COPILOT_STUDIO_PLUGINS.md](COPILOT_STUDIO_PLUGINS.md) — Copilot Studio agent configuration
- [IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md) — Component overview
- [../README.md](../README.md) — Project overview and quick start
